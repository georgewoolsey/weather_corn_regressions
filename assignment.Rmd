---
title: "Weather and Corn Yield Regressions"
author: "Nathan Mueller | Assignment completed by: George Woolsey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    # code_folding: hide
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'index.html')) })
---

```{r setup, include=FALSE, warning=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(viridis)
library(RColorBrewer)
library(scales)
####### read data req. for this assignment
library(R.matlab)
library(rnassqs)
####### spatial data
library(USAboundariesData)
library(USAboundaries)
library(sf)
library(mapview) #Interactive maps
library(leafpop) #map html popup


#define vars
my_qs_api_key <- "1E804485-6B71-3E4A-B74E-2340256BC471"
filter <- dplyr::filter

```

## Weather Data Analysis

### Load the PRISM daily maximum temperatures

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}

# daily max temperature
# dimensions: counties x days x years
prism <- readMat("data/prismiowa.mat")

# look at county #1
t_1981_c1 <- prism$tmaxdaily.iowa[1,,1]
t_1981_c1[366]
plot(1:366, t_1981_c1, type = "l")

ggplot() +
  geom_line(mapping = aes(x=1:366, y = t_1981_c1)) +
  theme_bw() +
  xlab("day of year") +
  ylab("daily maximum temperature (°C)") +
  ggtitle("Daily Maximum Temperature, Iowa County #1")


```

### tidy weather data

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}

# assign dimension names to tmax matrix
dimnames(prism$tmaxdaily.iowa) <- list(prism$COUNTYFP, 1:366, prism$years)

# converted 3d matrix into a data frame
tmaxdf <- as.data.frame.table(prism$tmaxdaily.iowa)

# relabel the columns
colnames(tmaxdf) <- c("countyfp","doy","year","tmax")
tmaxdf <- tibble(tmaxdf)

```

## Temperature trends

### Summer temperature trends: Winneshiek County

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}

tmaxdf$doy <- as.numeric(tmaxdf$doy)
tmaxdf$year <- as.numeric(as.character(tmaxdf$year))

winnesummer <- tmaxdf %>%
  filter(countyfp==191 & doy >= 152 & doy <= 243) %>%
  group_by(year) %>%
  summarize(meantmax = mean(tmax))

ggplot(winnesummer, mapping = aes(x = year, y = meantmax)) +
  geom_point() +
  theme_bw() +
  labs(x = "year", y = "Tmax (°C)") +
  geom_smooth(method = lm)

lm_summertmax <- lm(meantmax ~ year, winnesummer)
summary(lm_summertmax)

```

### Winter Temperatures - Winneshiek County

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}

winnewinter <- tmaxdf %>%
  filter(countyfp==191 & (doy <= 59 | doy >= 335) & !is.na(tmax)) %>%
  group_by(year) %>%
  summarize(meantmax = mean(tmax))

ggplot(winnewinter, mapping = aes(x = year, y = meantmax)) +
  geom_point() +
  theme_bw() +
  labs(x = "year", y = "Tmax (°C)") +
  geom_smooth(method = lm)

lm_wintertmax <- lm(meantmax ~ year, winnewinter)
summary(lm_wintertmax)

```

### Multiple regression -- Quadratic time trend

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}

winnewinter$yearsq <- winnewinter$year^2

lm_wintertmaxquad <- lm(meantmax ~ year + yearsq, winnewinter)
summary(lm_wintertmaxquad)
winnewinter$fitted <- lm_wintertmaxquad$fitted.values

ggplot(winnewinter) +
  geom_point(mapping = aes(x = year, y = meantmax)) +
  geom_line(mapping = aes(x = year, y = fitted)) +
  theme_bw() +
  labs(x = "year", y = "tmax")

```

### Download NASS corn yield data

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}

# set our API key with NASS
nassqs_auth(key = my_qs_api_key)

# parameters to query on 
params <- list(commodity_desc = "CORN", util_practice_desc = "GRAIN", prodn_practice_desc = "ALL PRODUCTION PRACTICES", year__GE = 1981, state_alpha = "IA")

# download
cornyieldsall <- nassqs_yields(params)

cornyieldsall$county_ansi <- as.numeric(cornyieldsall$county_ansi)
cornyieldsall$yield <- as.numeric(cornyieldsall$Value)

# clean and filter this dataset
cornyields <- select(cornyieldsall, county_ansi, county_name, yield, year) %>%
  filter(!is.na(county_ansi) & !is.na(yield))
cornyields <- tibble(cornyields) %>% 
  rename(year_id = year
         , yield_corn_bu_acre = yield # bushels per acre
    )

```

## Assignment

### Question 1a
Extract Winneshiek County corn yields, fit a linear time trend, make a plot. Is there a significant time trend?

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
# # check out yield data structure
# str(cornyields)
# nrow(cornyields)
# cornyields %>% distinct(county_ansi) %>% nrow(.)
# cornyields %>% distinct(county_ansi, year_id) %>% nrow(.)
# # row is unique by county, year

# filter to specific county
winneshiek_yields <- cornyields %>% 
  filter(toupper(county_name) == "WINNESHIEK")

# trend model for yield growth
lm_yeild_year <- lm(yield_corn_bu_acre ~ year_id , data = winneshiek_yields)

summary(lm_yeild_year)$coefficients["(Intercept)", "Estimate"]
# summary(lm_secchi_chla)$adj.r.squared

# label model in ggplot
model_label <- as.character(as.expression(
  substitute(
    italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2
    , list(
        a = scales::comma(summary(lm_yeild_year)$coefficients["(Intercept)", "Estimate"], accuracy = 0.1)
        , b = scales::comma(summary(lm_yeild_year)$coefficients[2, "Estimate"], accuracy = 0.1)
        , r2 = format(summary(lm_yeild_year)$r.squared, digits = 2)
      )
  )
))
# model_label

# plot
ggplot(winneshiek_yields, aes(x = year_id, y = yield_corn_bu_acre)) +
  geom_point(alpha=0.8, color = "navy", size = 2) + 
  geom_smooth(method = 'lm', color = "grey35") +
  annotate(geom = "text", label = model_label, parse = TRUE, x = -Inf, y = Inf, hjust = -0.1, vjust = 2) +
  scale_x_continuous(breaks = scales::extended_breaks(n=10)) +
  labs(
    title = "Corn Yield over time in  Winneshiek County, Iowa"
  ) +
  xlab("Year") +
  ylab("Corn Yield (bushels per acre)") +
  theme_bw() +
  theme(
    legend.position="none"
  )
```

<span style="color: blue;">There is a significant time trend in the corn yields in  Winneshiek County, Iowa from `r as.character(min(winneshiek_yields$year_id))` to `r as.character(max(winneshiek_yields$year_id))`. Based on a simple linear regression, every additional year results in the corn yield increasing by **`r round(summary(lm_yeild_year)$coefficients[2, "Estimate"], 2)` bu/acre**. The annual time trend explains **`r scales::percent(summary(lm_yeild_year)$r.squared)`** of the variation in corn yields in  Winneshiek County, Iowa.</span>

### Question 1b
Fit a quadratic time trend (i.e., year + year^2) and make a plot. Is there evidence for slowing yield growth? 

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
# quadratic trend model for evidence of slowing yield growth
winneshiek_yields <- winneshiek_yields %>% 
  mutate(year_id_sq = year_id^2)

# run model
lm_yeild_year_quad <- lm(yield_corn_bu_acre ~ year_id + year_id_sq, data = winneshiek_yields)
summary(lm_yeild_year_quad)

# save fitted values
winneshiek_yields$fitted_quad <- lm_yeild_year_quad$fitted.values

# label model in ggplot
model_label_quad <- as.character(as.expression(
  substitute(
    italic(y) == a + b %.% italic(x) + c %.% ~italic(x)^2~","~~italic(r)^2~"="~r2
    , list(
        a = scales::comma(summary(lm_yeild_year_quad)$coefficients["(Intercept)", "Estimate"], accuracy = 0.1)
        , b = scales::comma(summary(lm_yeild_year_quad)$coefficients[2, "Estimate"], accuracy = 0.2)
        , c = scales::comma(summary(lm_yeild_year_quad)$coefficients[3, "Estimate"], accuracy = 0.0001)
        , r2 = format(summary(lm_yeild_year_quad)$r.squared, digits = 2)
      )
  )
))
# model_label_quad

# plot
ggplot(winneshiek_yields, aes(x = year_id, y = yield_corn_bu_acre)) +
  geom_point(alpha=0.8, color = "navy", size = 2) +
  geom_line(aes(x = year_id, y = fitted_quad), color = "grey35") +
  annotate(geom = "text", label = model_label_quad, parse = TRUE, x = -Inf, y = Inf, hjust = -0.1, vjust = 2) +
  scale_x_continuous(breaks = scales::extended_breaks(n=10)) +
  labs(
    title = "Corn Yield over time in  Winneshiek County, Iowa"
    , subtitle = "with fitted values from quadratic time trend (i.e., year + year^2)"
  ) +
  xlab("Year") +
  ylab("Corn Yield (bushels per acre)") +
  theme_bw() +
  theme(
    legend.position="none"
  )

```

<span style="color: blue;">Using a quadratic time trend (i.e., year + year^2) shows a significant time trend in the corn yields in  Winneshiek County, Iowa from `r as.character(min(winneshiek_yields$year_id))` to `r as.character(max(winneshiek_yields$year_id))`. Based on a the quadratic model, there is a slightly *increasing* rate of corn yeild over time. The quadratic time trend explains **`r scales::percent(summary(lm_yeild_year_quad)$r.squared)`** of the variation in corn yields in  Winneshiek County, Iowa.</span>



### Question 2
Time Series: Let's analyze the relationship between temperature and yields for the Winneshiek County time series. Use data on yield and summer avg Tmax. Is adding year or Tmax^2 to your model helpful? Make a plot and interpret the results.

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
#code

```

### Question 3
Cross-Section: Analyze the relationship between temperature and yield across all counties in 2018. Is there a relationship? Interpret the results.

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
#code

```


### Question 4
Panel: One way to leverage multiple time series is to group all data into what is called a "panel" regression. Convert the county ID code ("countyfp" or "county_ansi") into factor using as.factor, then include this variable in a regression using all counties' yield and summer temperature data. How does the significance of your temperature coefficients (Tmax, Tmax^2) change? Make a plot comparing actual and fitted yields and interpret the results of your model.

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
#code

```


### Question 5
Soybeans: Download NASS data on soybean yields and explore either a time series relationship for a given county, the cross-sectional relationship for a given year, or a panel across all counties and years.

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
#code

```


### Bonus
Find a package to make a county map of Iowa displaying some sort of information about yields or weather. Interpret your map.

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
# pull in spatial county data to join on count FIPS code
counties <- us_counties() %>%
  setNames(make.names(names(.), unique = TRUE)) %>% # for some reason the state_name field is duplicated
  mutate(county_ansi = as.numeric(countyfp)) %>%
  filter(state_name == "Iowa") %>% 
  st_transform(2163) # EPSG:2163 = US National Atlas Equal Area

# mapview(counties)

# join to yields
spatial_county_yields <- inner_join(counties, cornyields, by = "county_ansi")
# mapview(spatial_county_yields %>% filter(year_id == 2001), zcol = "yield_corn_bu_acre")


```


### Bonus #2
Challenge question - map trends in corn yields by county across Iowa. Interpret your map.

```{r, warning=F, message=F, results='hide', fig.width = 8, fig.height = 5}
#code

```

